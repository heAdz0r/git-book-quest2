#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–ª–∏–∑–∞ –≤ git-book-quest2

set -e

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -d ".git" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
CURRENT_BRANCH=$(git branch --show-current)
echo "üìç –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ–≥
TIMESTAMP=$(date +%s)
TAG="v1.0.$TIMESTAMP"
TITLE="Test Release $TAG"
NOTES="üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–ª–∏–∑ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ webhook'–æ–≤

–°–æ–∑–¥–∞–Ω: $(date)
–í–µ—Ç–∫–∞: $CURRENT_BRANCH
–ö–æ–º–º–∏—Ç: $(git rev-parse --short HEAD)

–≠—Ç–æ—Ç —Ä–µ–ª–∏–∑ —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ GitHub —Ä–µ–ª–∏–∑–æ–≤."

echo "üè∑Ô∏è  –°–æ–∑–¥–∞–µ–º —Ç–µ–≥: $TAG"

# –°–æ–∑–¥–∞–µ–º –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–≥
git tag -a "$TAG" -m "$TITLE"

echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–≥ –Ω–∞ GitHub..."

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–≥
git push origin "$TAG"

echo "‚úÖ –¢–µ–≥ $TAG —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ GitHub CLI
if command -v gh &> /dev/null; then
    echo "üöÄ –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑ —á–µ—Ä–µ–∑ GitHub CLI..."
    
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑
    gh release create "$TAG" \
        --title "$TITLE" \
        --notes "$NOTES" \
        --latest
    
    echo "üéâ –†–µ–ª–∏–∑ $TAG —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
    echo "üîó –°—Å—ã–ª–∫–∞: https://github.com/$(gh repo view --json owner,name -q '.owner.login + "/" + .name')/releases/tag/$TAG"
else
    echo "‚ö†Ô∏è  GitHub CLI –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–ª–∏–∑ –≤—Ä—É—á–Ω—É—é:"
    echo "   1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://github.com/heAdz0r/git-book-quest2/releases"
    echo "   2. –ù–∞–∂–º–∏—Ç–µ 'Create a new release'"
    echo "   3. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥: $TAG"
    echo "   4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ"
    echo "   5. –û–ø—É–±–ª–∏–∫—É–π—Ç–µ —Ä–µ–ª–∏–∑"
fi

echo ""
echo "üìä –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ webhook'–∞:"
echo "   ‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞"
echo "   ‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ"